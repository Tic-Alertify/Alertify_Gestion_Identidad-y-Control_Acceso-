{
  "info": {
    "name": "Alertify - Gestión Identidad Sprint 1",
    "description": "Colección de pruebas para endpoints de autenticación.\n\nT12: Todas las respuestas de error incluyen: statusCode, message, error, code, path, requestId, timestamp.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Registro",
      "item": [
        {
          "name": "Test 1: Registro exitoso",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"test@alertify.com\",\n  \"username\": \"testuser\",\n  \"password\": \"Password123!\"\n}"
            },
            "url": {
              "raw": "http://localhost:3000/auth/registro",
              "protocol": "http",
              "host": ["localhost"],
              "port": "3000",
              "path": ["auth", "registro"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Response contains message and userId', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('message', 'Usuario registrado exitosamente');",
                  "    pm.expect(jsonData).to.have.property('userId');",
                  "    pm.expect(jsonData.userId).to.be.a('number');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Test 2: Email duplicado",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"test@alertify.com\",\n  \"username\": \"testuser2\",\n  \"password\": \"Password123!\"\n}"
            },
            "url": {
              "raw": "http://localhost:3000/auth/registro",
              "protocol": "http",
              "host": ["localhost"],
              "port": "3000",
              "path": ["auth", "registro"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 409', function () {",
                  "    pm.response.to.have.status(409);",
                  "});",
                  "",
                  "pm.test('Response contains conflict message', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.message).to.equal('El email ya está registrado');",
                  "});",
                  "",
                  "pm.test('T12: Error response has standard fields', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('code', 'RESOURCE_CONFLICT');",
                  "    pm.expect(jsonData).to.have.property('path', '/auth/registro');",
                  "    pm.expect(jsonData).to.have.property('requestId');",
                  "    pm.expect(jsonData).to.have.property('timestamp');",
                  "});",
                  "",
                  "pm.test('T12: x-request-id header present', function () {",
                  "    pm.response.to.have.header('x-request-id');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Test 2b: Username duplicado",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"otro@alertify.com\",\n  \"username\": \"testuser\",\n  \"password\": \"Password123!\"\n}"
            },
            "url": {
              "raw": "http://localhost:3000/auth/registro",
              "protocol": "http",
              "host": ["localhost"],
              "port": "3000",
              "path": ["auth", "registro"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 409', function () {",
                  "    pm.response.to.have.status(409);",
                  "});",
                  "",
                  "pm.test('Response contains conflict message', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.message).to.equal('El nombre de usuario no está disponible');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Test 2c: Validaciones DTO fallidas",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"invalido\",\n  \"username\": \"ab\",\n  \"password\": \"weak\"\n}"
            },
            "url": {
              "raw": "http://localhost:3000/auth/registro",
              "protocol": "http",
              "host": ["localhost"],
              "port": "3000",
              "path": ["auth", "registro"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Response contains validation errors', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.message).to.be.an('array');",
                  "});",
                  "",
                  "pm.test('T12: Validation error has code VALIDATION_ERROR', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('code', 'VALIDATION_ERROR');",
                  "    pm.expect(jsonData).to.have.property('path', '/auth/registro');",
                  "    pm.expect(jsonData).to.have.property('requestId');",
                  "    pm.expect(jsonData).to.have.property('timestamp');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Login",
      "item": [
        {
          "name": "Test 3: Login exitoso",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"test@alertify.com\",\n  \"password\": \"Password123!\"\n}"
            },
            "url": {
              "raw": "http://localhost:3000/auth/login",
              "protocol": "http",
              "host": ["localhost"],
              "port": "3000",
              "path": ["auth", "login"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response contains access_token', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('access_token');",
                  "    pm.expect(jsonData.access_token).to.be.a('string');",
                  "});",
                  "",
                  "pm.test('Response contains user info', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.user).to.have.property('id');",
                  "    pm.expect(jsonData.user).to.have.property('email', 'test@alertify.com');",
                  "    pm.expect(jsonData.user).to.have.property('username', 'testuser');",
                  "    pm.expect(jsonData.user.roles).to.include('CIUDADANO');",
                  "});",
                  "",
                  "// Guardar token para futuro uso",
                  "if (pm.response.code === 200) {",
                  "    pm.environment.set('access_token', pm.response.json().access_token);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Test 4: Login contraseña incorrecta (T12: 401)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"test@alertify.com\",\n  \"password\": \"WrongPass\"\n}"
            },
            "url": {
              "raw": "http://localhost:3000/auth/login",
              "protocol": "http",
              "host": ["localhost"],
              "port": "3000",
              "path": ["auth", "login"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 401', function () {",
                  "    pm.response.to.have.status(401);",
                  "});",
                  "",
                  "pm.test('Response contains error message', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.message).to.equal('Credenciales inválidas');",
                  "});",
                  "",
                  "pm.test('T12: 401 has AUTH_INVALID_CREDENTIALS code', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('code', 'AUTH_INVALID_CREDENTIALS');",
                  "    pm.expect(jsonData).to.have.property('path', '/auth/login');",
                  "    pm.expect(jsonData).to.have.property('requestId');",
                  "    pm.expect(jsonData).to.have.property('timestamp');",
                  "});",
                  "",
                  "pm.test('T12: x-request-id header present', function () {",
                  "    pm.response.to.have.header('x-request-id');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Test 4b: Login email inexistente (T12: 401)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"noexiste@alertify.com\",\n  \"password\": \"Password123!\"\n}"
            },
            "url": {
              "raw": "http://localhost:3000/auth/login",
              "protocol": "http",
              "host": ["localhost"],
              "port": "3000",
              "path": ["auth", "login"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 401', function () {",
                  "    pm.response.to.have.status(401);",
                  "});",
                  "",
                  "pm.test('Response contains error message', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.message).to.equal('Credenciales inválidas');",
                  "});",
                  "",
                  "pm.test('T12: Same message as wrong password (no email enumeration)', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.equal('AUTH_INVALID_CREDENTIALS');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Test 5: Login cuenta bloqueada (T12: 403)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"bloqueado@alertify.com\",\n  \"password\": \"Password123!\"\n}"
            },
            "url": {
              "raw": "http://localhost:3000/auth/login",
              "protocol": "http",
              "host": ["localhost"],
              "port": "3000",
              "path": ["auth", "login"]
            },
            "description": "PREREQUISITO: Crear manualmente usuario con estado 'bloqueado' en la BD para este test.\nSQL: INSERT INTO usuarios (email, username, password_hash, estado) VALUES ('bloqueado@alertify.com', 'bloqueado', '<hash>', 'bloqueado');"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 403', function () {",
                  "    pm.response.to.have.status(403);",
                  "});",
                  "",
                  "pm.test('Response contains forbidden message', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.message).to.equal('La cuenta está bloqueada.');",
                  "});",
                  "",
                  "pm.test('T12: 403 has AUTH_ACCOUNT_BLOCKED code', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('code', 'AUTH_ACCOUNT_BLOCKED');",
                  "    pm.expect(jsonData).to.have.property('path', '/auth/login');",
                  "    pm.expect(jsonData).to.have.property('requestId');",
                  "    pm.expect(jsonData).to.have.property('timestamp');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    }
  ]
}
